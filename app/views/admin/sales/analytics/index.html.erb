<div class="space-y-6">
  <!-- ページヘッダー -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">営業分析レポート</h1>
      <p class="mt-1 text-sm text-gray-500">売上・利益・見込み分析の可視化</p>
    </div>
    <div class="flex gap-2">
      <select class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
        <% @periods.each do |period| %>
          <option <%= 'selected' if period == @selected_period %>><%= period %></option>
        <% end %>
      </select>
      <button class="btn-secondary text-sm">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        CSV出力
      </button>
      <button class="btn-primary text-sm">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        PDF出力
      </button>
    </div>
  </div>

  <!-- KPIサマリー -->
  <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-6">
    <div class="card p-4">
      <p class="text-xs font-medium text-gray-500">総売上</p>
      <p class="mt-2 text-2xl font-bold text-gray-900">
        <%= number_to_currency(@kpis[:total_revenue], unit: "¥", precision: 0, format: "%u%n", delimiter: ",") %>
      </p>
    </div>
    <div class="card p-4">
      <p class="text-xs font-medium text-gray-500">利益率</p>
      <p class="mt-2 text-2xl font-bold text-green-600"><%= @kpis[:profit_margin] %>%</p>
    </div>
    <div class="card p-4">
      <p class="text-xs font-medium text-gray-500">受注率</p>
      <p class="mt-2 text-2xl font-bold text-blue-600"><%= @kpis[:success_rate] %>%</p>
    </div>
    <div class="card p-4">
      <p class="text-xs font-medium text-gray-500">進行中案件</p>
      <p class="mt-2 text-2xl font-bold text-orange-600"><%= @kpis[:active_deals] %></p>
    </div>
    <div class="card p-4">
      <p class="text-xs font-medium text-gray-500">新規案件</p>
      <p class="mt-2 text-2xl font-bold text-purple-600"><%= @kpis[:new_deals] %></p>
    </div>
    <div class="card p-4">
      <p class="text-xs font-medium text-gray-500">成約案件</p>
      <p class="mt-2 text-2xl font-bold text-green-600"><%= @kpis[:closed_deals] %></p>
    </div>
  </div>

  <!-- 売上推移グラフ -->
  <div class="card p-6">
    <h3 class="text-lg font-bold text-gray-900 mb-4">月別売上推移（12ヶ月）</h3>
    <div class="h-80">
      <!-- グラフ風の棒グラフ表示（SVG風） -->
      <div class="flex items-end justify-between h-full border-b border-l border-gray-300 pb-8 pl-8">
        <% max_revenue = @monthly_revenue.map { |m| m[:revenue] }.max %>
        <% @monthly_revenue.last(12).each do |month_data| %>
          <div class="flex flex-col items-center flex-1 px-1">
            <div class="w-full bg-blue-500 rounded-t-lg hover:bg-blue-600 transition cursor-pointer relative group"
                 style="height: <%= (month_data[:revenue].to_f / max_revenue * 100).round %>%"
                 title="<%= month_data[:month] %>: <%= number_to_currency(month_data[:revenue], unit: "¥", precision: 0, format: "%u%n") %>">
              <!-- ツールチップ風 -->
              <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap">
                <%= number_to_currency(month_data[:revenue], unit: "¥", precision: 0, format: "%u%n", delimiter: ",") %><br>
                案件数: <%= month_data[:deals] %>件
              </div>
            </div>
            <span class="text-xs text-gray-600 mt-2 -rotate-45 origin-top-left">
              <%= month_data[:month].split('-').last %>月
            </span>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- 2列レイアウト -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- ステージ別案件分布 -->
    <div class="card p-6">
      <h3 class="text-lg font-bold text-gray-900 mb-4">ステージ別案件分布</h3>
      <div class="space-y-4">
        <% @stage_distribution.each do |stage| %>
          <div>
            <div class="flex items-center justify-between mb-1">
              <span class="text-sm font-medium text-gray-700"><%= stage[:stage] %></span>
              <span class="text-sm font-bold text-gray-900">
                <%= number_to_currency(stage[:amount], unit: "¥", precision: 0, format: "%u%n", delimiter: ",") %>
                (<%= stage[:percentage] %>%)
              </span>
            </div>
            <div class="flex items-center">
              <div class="flex-1 bg-gray-200 rounded-full h-3">
                <div class="bg-blue-600 h-3 rounded-full" style="width: <%= stage[:percentage] %>%"></div>
              </div>
              <span class="ml-3 text-sm text-gray-600"><%= stage[:count] %>件</span>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- 業種別売上 -->
    <div class="card p-6">
      <h3 class="text-lg font-bold text-gray-900 mb-4">業種別売上分布</h3>
      <div class="space-y-4">
        <% @industry_revenue.each_with_index do |industry, index| %>
          <div>
            <div class="flex items-center justify-between mb-1">
              <span class="text-sm font-medium text-gray-700"><%= industry[:industry] %></span>
              <span class="text-sm font-bold text-gray-900">
                <%= number_to_currency(industry[:revenue], unit: "¥", precision: 0, format: "%u%n", delimiter: ",") %>
              </span>
            </div>
            <div class="flex items-center">
              <div class="flex-1 bg-gray-200 rounded-full h-3">
                <% colors = ['bg-blue-600', 'bg-green-600', 'bg-purple-600', 'bg-orange-600', 'bg-gray-600'] %>
                <div class="<%= colors[index % colors.length] %> h-3 rounded-full"
                     style="width: <%= industry[:percentage] %>%"></div>
              </div>
              <span class="ml-3 text-sm text-gray-600"><%= industry[:deals] %>件</span>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- 営業担当別実績ランキング -->
  <div class="card p-6">
    <h3 class="text-lg font-bold text-gray-900 mb-4">営業担当別実績ランキング</h3>
    <div class="overflow-x-auto">
      <table class="min-w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">順位</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">担当者</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">案件数</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">売上</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">利益</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">受注率</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">平均案件単価</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @sales_performance.each_with_index do |perf, index| %>
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <% if index == 0 %>
                  <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-yellow-100 text-yellow-800 font-bold">🥇</span>
                <% elsif index == 1 %>
                  <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 text-gray-800 font-bold">🥈</span>
                <% elsif index == 2 %>
                  <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-orange-100 text-orange-800 font-bold">🥉</span>
                <% else %>
                  <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-50 text-gray-600 font-medium"><%= index + 1 %></span>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center mr-3">
                    <span class="text-white font-medium text-sm"><%= perf[:name][0] %></span>
                  </div>
                  <div class="font-medium text-gray-900"><%= perf[:name] %></div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium text-gray-900">
                <%= perf[:deals] %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-gray-900">
                <%= number_to_currency(perf[:revenue], unit: "¥", precision: 0, format: "%u%n", delimiter: ",") %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-green-600">
                <%= number_to_currency(perf[:profit], unit: "¥", precision: 0, format: "%u%n", delimiter: ",") %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= perf[:success_rate] >= 75 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800' %>">
                  <%= perf[:success_rate] %>%
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-600">
                <%= number_to_currency(perf[:average_deal], unit: "¥", precision: 0, format: "%u%n", delimiter: ",") %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 月次目標達成率 -->
  <div class="card p-6">
    <h3 class="text-lg font-bold text-gray-900 mb-4">月次目標達成率（直近4ヶ月）</h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <% @monthly_targets.each do |target| %>
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="text-sm text-gray-600 mb-2"><%= target[:month].split('-').last %>月</div>
          <div class="mb-2">
            <div class="flex items-baseline justify-between mb-1">
              <span class="text-xs text-gray-500">目標</span>
              <span class="text-sm font-medium text-gray-700">
                <%= number_to_currency(target[:target], unit: "¥", precision: 0, format: "%u%n", delimiter: ",") %>
              </span>
            </div>
            <div class="flex items-baseline justify-between">
              <span class="text-xs text-gray-500">実績</span>
              <span class="text-sm font-bold text-gray-900">
                <%= number_to_currency(target[:actual], unit: "¥", precision: 0, format: "%u%n", delimiter: ",") %>
              </span>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
              <div class="bg-green-600 h-2 rounded-full" style="width: <%= [target[:rate], 100].min %>%"></div>
            </div>
            <span class="text-sm font-bold <%= target[:rate] >= 100 ? 'text-green-600' : 'text-orange-600' %>">
              <%= target[:rate] %>%
            </span>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
